% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/get_nass_historical_track_record_crop.R
\name{get_nass_historical_track_record_crop}
\alias{get_nass_historical_track_record_crop}
\title{Download and Process USDA NASS Historical Crop Track Records}
\usage{
get_nass_historical_track_record_crop(
  url = "https://usda.library.cornell.edu/concern/publications/c534fn92g?locale=en",
  dir_source = "./data-raw/fastscratch/nass/"
)
}
\arguments{
\item{url}{Character. URL of the USDA NASS historical track record page.}

\item{dir_source}{Character. Directory into which to download and extract the ZIP file.
Default is \code{"./data-raw/fastscratch/nass/"}. Must exist or be creatable.}
}
\value{
A data.table in which each row corresponds to a crop-year, with standardized
track record measures for area planted, area harvested, production, yield, and price.
}
\description{
Scrapes the USDA NASS historical track records web page to identify and download
the latest \code{croptrXX.zip} archive, parses its index to locate CSV tables for area
planted and harvested by crop, reads and reshapes each table, cleans and standardizes
units and variable names, applies special-case unit conversions, and returns a
unified time series data frame of crop-level measures (area planted, area harvested,
production, yield, price).
}
\details{
\enumerate{
\item \strong{Link discovery & download}
\itemize{
\item Reads all \verb{<a>} hrefs from \code{url}, filters for links containing \code{"c534fn92g"},
\code{"zip"}, and \code{"croptr"}.
\item Extracts the year from each filename and selects the link with the maximum year.
\item Downloads that single ZIP as \code{croptr.zip} into \code{dir_source}.
}
\item \strong{Index parsing}
\itemize{
\item Opens \code{crop_index.htm} inside the ZIP, extracts the second HTML table as text.
\item Splits on double line breaks, filters to lines mentioning "Area Planted" or
"Area Harvested", and excludes summary or non-crop entries.
\item Splits each line into \code{Page}, \code{File}, \code{Description}, then further into \code{Description}
and a year range (\code{start}/\code{end}), and derives the uppercase crop name.
}
\item \strong{CSV reading & reshaping}
\itemize{
\item For each row of the index:
\itemize{
\item Reads the CSV inside the ZIP once to locate header (\code{h}), unit (\code{u}), and data (\code{d}) rows.
\item Reads it again skipping to the data start, then loops over each data column to build
a long table with columns \code{crop}, \code{crop_yr}, \code{variable}, \code{unit}, and \code{value}.
}
\item Combines all tables into one data.frame.
}
\item \strong{Cleaning & standardization}
\itemize{
\item Converts \code{crop_yr} and \code{value} to numeric, drops zeros and invalids.
\item Scales values when unit indicates thousands, strips formatting characters,
and normalizes variable names.
\item Consolidates crop subtypes (e.g. grain/silage/grazed) under a single \code{crop}.
}
\item \strong{Variable mapping & special conversions}
\itemize{
\item Identifies key measures via lookup lists (\verb{Area Planted}, \verb{Area Harvested},
\code{Production}, \code{Yield}, \code{Price}) and relabels them to \code{"Tracks_*"}.
\item Applies special-case unit conversions (cents to dollars, bales to lbs, cwt to lbs, tons to lbs,
etc.), including crop-specific rules (cotton, canola, dry beans, rice, sugarbeet,
sugarcane, sunflower).
}
\item \strong{Final pivot}
\itemize{
\item Pivots the cleaned long table to wide format so each \code{"Tracks_*"} measure is its
own column, and returns a data.frame with columns:
\code{CROP}, \code{crop_year}, \code{Tracks_area_planted}, \code{Tracks_area_harvested},
\code{Tracks_production}, \code{Tracks_yield}, \code{Tracks_price}.
}
}
}
